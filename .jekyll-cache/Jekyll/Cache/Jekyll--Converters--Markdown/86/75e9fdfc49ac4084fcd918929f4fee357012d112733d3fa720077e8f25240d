I"g8<h2 id="introduction-to-ecn">Introduction to ECN</h2>

<p>Explicit Congestion Notification (or ECN), enables end-to-end network congestion
notification between a client and a server, without the dropping of packets. It is an extension
to the TCP/IP protocol. When a congestion is encountered, instead of dropping packets,
an ECN-aware router can ‘mark’ the packets in order to signal an incoming congestion
in the network. The receiver of such a marked packet echoes this message back to the
sender, who then reduces their data transmission rate so as to prevent congestion and
dropping of packets in the network.</p>

<p>In 2012, only about 8.5% of the most popular websites supported ECN. But as of 2017, the number had increased to over 70%, and possibly even more in the  years.</p>

<h4 id="working">Working</h4>

<p>ECN requires specific support at both the Internet layer and the transport layer for the following reasons:</p>

<ul>
  <li>In TCP/IP, routers operate within the Internet layer, while the transmission rate is handled by the endpoints at the transport layer.</li>
  <li>Congestion may be handled only by the transmitter, but since it is known to have happened only after a packet was sent, there must be an echo of the congestion indication by the receiver to the transmitter.</li>
</ul>

<h4 id="initial-communication-of-ecn-support-between-client-and-server">Initial Communication of ECN Support between Client and Server:</h4>
<p>In the TCP header, the first two bits in byte 14 are defined as flags for the use of ECN,
namely the ECE (Echo - Congestion Encountered) and CWR (Congestion Window
Reduced) bits.</p>

<p><img src="/assets/img/ECN/ecn_bits_tcp.jpg" alt="TCP Header with ECN related bits" /></p>
<blockquote>
  <p>Credits: <a href="https://slideplayer.com/slide/4764320/">https://slideplayer.com/slide/4764320/</a></p>
</blockquote>

<p>According to the convention, a TCP client indicates that it supports ECN by
setting ECE=CWR=1 in the SYN, and an ECN-enabled server confirms ECN support by
setting ECE=1 and CWR=0 in the SYN/ACK packet.</p>

<h4 id="ecn-usage-during-transmission">ECN Usage During Transmission:</h4>
<p>Once ECN has been negotiated with the receiver at the transport layer, an ECN sender
can set two possible codepoints ( ECT(0) or ECT(1) ) in the IP header to indicate an
ECN-capable transport (ECT).</p>

<p><img src="https://1.bp.blogspot.com/-tfuhIb-blCE/T5QidPZHTgI/AAAAAAAAEoQ/s5Prfka2gZ4/s1600/a.jpg" alt="ECN Related bits in IPv4 Header" /></p>
<blockquote>
  <p>Credits: <a href="http://cisco-telepresence.blogspot.com/2012/05/explicit-congestion-notification.html">http://cisco-telepresence.blogspot.com/2012/05/explicit-congestion-notification.html</a></p>
</blockquote>

<p>If both ECN bits are zero, the packet is considered to have
been sent by a Not-ECN-capable Transport ( Not-ECT ). When a network node
experiences congestion, it will occasionally either drop or mark a packet, with the choice
depending on the packet’s ECN codepoint. If the codepoint is Not-ECT, only drop is
appropriate. If the codepoint is ECT(0) or ECT(1), the node can mark the packet by
setting both ECN bits , which is termed ‘Congestion Experienced’ (CE), or loosely a
‘congestion mark’.</p>

<p>On reception of a CE-marked packet at the IP layer, the Data Receiver starts to set the
Echo Congestion Experienced (ECE) flag continuously in the TCP header of ACKs,
which ensures the signal is received reliably even if ACKs are lost. The TCP sender
confirms that it has received at least one ECE signal by responding with the Congestion
Window Reduced (CWR) flag, which allows the TCP receiver to stop repeating the
ECN-Echo flag.</p>

<h2 id="inspecting-ecn-use-in-practice-with-wireshark">Inspecting ECN Use in Practice with Wireshark</h2>

<p>In this analysis, we are visiting https://www.wikiversity.com, which runs on the HTTPS protocol. HTTP and HTTPS use TCP as the Transport Layer protocol, so there is a possibility of ECN support here. Analysis of incoming/outgoing traffic to this host in Wireshark can be done by setting the Capture Filter appropriately:</p>

<p><img src="/assets/img/ECN/capture_filter.png" alt="Host Capture Filter" /></p>

<p><strong>ECN Related Details</strong>: Initially, a TCP SYN packet is sent with the ECE and CWR bits set to 1,
which indicates that our client system <strong>supports ECN</strong> according to the convention.</p>

<p><img src="/assets/img/ECN/client_ecn.png" alt="Client ECN Support" /></p>

<p>The Wikiversity server also <strong>supports ECN</strong>, which is indicated by the <em>ECE</em> bit being <strong>1</strong> and
<em>CWR</em> bit being <strong>0</strong> in the <strong>SYN+ACK</strong> response.</p>

<p><img src="/assets/img/ECN/website_ecn.png" alt="Website ECN Support" /></p>

<h2 id="script-to-check-for-ecn-support">Script to check for ECN support</h2>

<p>The following Python3 script checks whether the websites in the entered website list support ECN or not.  Note that the support of ECN in the connection between you (the client) and the server also depends on whether the entire underlying network infrastructure from the client-side till the server (OS, LAN, ISP’s infrastructure, server, etc.) supports ECN.</p>

<p>Ensure you have <em>scapy</em> installed by running<br />
<code class="language-plaintext highlighter-rouge">pip install --pre scapy[complete]</code></p>

<p><strong>Script:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="s">"""
The following is a python script that takes a URL
input from the command line, and using the
'scapy' python library, creates a TCP SYN
request to the website with the ECN-Echo and
CWR flags set to 1. The script then receives the
response, and checks if the SYN+ACK+ECN bits are
set in the TCP flags of the response. If the SYN+ACK
bits are set, it indicates that this is the response 
we are looking for to check for server-side ECN support; 
if the ECN-Echo bit is set in this packet, it
indicates that the website supports ECN.

Writes the output to a file name ECN_Support.txt

This script supports multiple websites - enter multiple websites
as command line arguments to check their ECN support.

How to use:
Ensure you have python3.6+ installed

Install scapy by running
pip install --pre scapy[complete]

Usage: 
sudo python3 script.py [website_list]

Example:
sudo python3 script.py www.facebook.com www.twitter.com

"""</span>

<span class="kn">import</span> <span class="nn">sys</span>  <span class="c1"># to get the command line arguments
</span><span class="kn">from</span> <span class="nn">scapy.all</span> <span class="kn">import</span> <span class="o">*</span>  <span class="c1"># we will use the scapy library to create and receive
</span>                         <span class="c1"># the packets.
</span>

<span class="s">"""
This function creates and receives packets for 
all the websites entered in the command line
arguments, checks for their validity and returns
all the response packets.
"""</span>
<span class="k">def</span> <span class="nf">get_packet</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Enter atleast one website!'</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">recvd_pkts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">website</span> <span class="ow">in</span> <span class="n">address</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">sr1</span><span class="p">(</span><span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="n">website</span><span class="p">)</span><span class="o">/</span><span class="n">TCP</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="s">"SEC"</span><span class="p">))</span>
            <span class="n">recvd_pkts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">f'</span><span class="si">{</span><span class="n">website</span><span class="si">}</span><span class="s"> is an invalid address!'</span><span class="p">)</span>  <span class="c1"># if any of the websites entered are invalid.
</span>        <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">return</span> <span class="n">recvd_pkts</span>  <span class="c1"># returns the list of received packets.
</span>

<span class="s">"""
This function checks if the packet received has
the correct TCP headers for ECN support set or not.
"""</span>
<span class="k">def</span> <span class="nf">check_packet</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>  <span class="c1"># this function checks if the correct TCP flags are
</span>                      <span class="c1"># set in the response packet.
</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="n">TCP</span><span class="p">].</span><span class="n">flags</span> <span class="o">==</span> <span class="s">'SAE'</span><span class="p">:</span>  <span class="c1"># are the SYN + ACK + ECN bits set?
</span>        <span class="k">return</span> <span class="s">'YES'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">'NO'</span>


<span class="s">"""
Driver function for the program
"""</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># get all the websites entered as command
</span>                            <span class="c1"># line arguments in a list form.
</span>    <span class="n">recvd_pkts</span> <span class="o">=</span> <span class="n">get_packet</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">recvd_pkts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1"># one or more addresses was incorrect.
</span>        <span class="nb">exit</span><span class="p">()</span>

    <span class="n">ecn_support</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">packet</span> <span class="ow">in</span> <span class="n">recvd_pkts</span><span class="p">:</span>
        <span class="n">ecn_support</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">check_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">))</span>  <span class="c1"># checks for ECN support and
</span>                                                  <span class="c1"># appends 'YES' or 'NO'
</span>
    <span class="c1"># only after checking if all entered websites are valid and
</span>    <span class="c1"># getting the response packets from all of them, we
</span>    <span class="c1"># write to the file.
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"ECN_Support.txt"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ecn_support</span><span class="p">)):</span>
            <span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s">' '</span> <span class="o">+</span> <span class="n">recvd_pkts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">IP</span><span class="p">].</span><span class="n">src</span> <span class="o">+</span> <span class="s">' '</span> <span class="o">+</span> <span class="n">ecn_support</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>


<span class="c1"># this program should only work when executed directly
# from the command line. When it is, the main() function
# is initially called with the help of the below code.
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>  
    <span class="n">main</span><span class="p">()</span>

</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we have explored what ECN is, it’s technical implementation details, a Wireshark analysis of a real-world scenario and finally a script to check ECN support of any website.</p>

<h4 id="references">References</h4>

<p><a href="https://en.wikipedia.org/wiki/Explicit_Congestion_Notification">https://en.wikipedia.org/wiki/Explicit_Congestion_Notification</a><br />
<a href="https://tools.ietf.org/id/draft-ietf-tcpm-accurate-ecn-05.html">https://tools.ietf.org/id/draft-ietf-tcpm-accurate-ecn-05.html</a></p>

<h4 id="further-reading">Further Reading</h4>

<p><a href="https://ieeexplore.ieee.org/document/9058340">Enhanced ECN</a><br />
<a href="https://cumulusnetworks.com/blog/explicit-congestion-notification/">Deploying ECN for your network</a></p>
:ET